<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>库存盘点系统</title>
  <style>
    body { font-family: Arial, sans-serif; padding:10px; }
    table { border-collapse: collapse; width:100%; margin-top:20px; }
    th, td { border:1px solid #ccc; padding:8px; text-align:center; }
    th { background:#f0f0f0; }
    td[contenteditable] { background:#fff8dc; }
    .delete-btn, .upload-btn { padding:4px 8px; margin:2px; cursor:pointer; }
    .img-modal { display:none; position:fixed; top:0; left:0; right:0; bottom:0;
                 background: rgba(0,0,0,0.8); justify-content:center; align-items:center; }
    .img-modal img { max-width:90%; max-height:90%; border:4px solid white; border-radius:8px; }
    .img-modal-close { position:absolute; top:20px; right:20px; color:white; font-size:30px; cursor:pointer; }
  </style>
</head>
<body>
<h2>库存盘点系统</h2>
<input type="file" id="csvInput" accept=".csv">
<button onclick="exportCSV()">导出 CSV</button>
<table id="inventoryTable">
  <thead>
    <tr>
      <th>序号</th>
      <th>物料编号</th>
      <th>物料名称</th>
      <th>规格</th>
      <th>系统数量</th>
      <th>实际数量</th>
      <th>存放位置</th>
      <th>操作</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div class="img-modal" id="imgModal">
  <span class="img-modal-close" onclick="closeImgModal()">&times;</span>
  <img id="modalImg">
</div>
<script>
const tbody = document.querySelector("#inventoryTable tbody");
const csvInput = document.getElementById("csvInput");
let inventory = [];

csvInput.addEventListener("change", handleCSVImport);

function handleCSVImport(e){
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(evt){
    const lines = evt.target.result.split('\n').map(l=>l.trim()).filter(l=>l);
    inventory = [];
    tbody.innerHTML = '';
    lines.forEach((line,i)=>{
      if(i===0) return; // 跳过表头
      // 修复名称中逗号问题，使用正则匹配 CSV 格式
      const cols = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g).map(c=>c.replace(/^"|"$/g,''));
      const item = {
        code: cols[0]||'',
        name: cols[1]||'',
        spec: cols[2]||'',
        sysQty: cols[3]||'',
        realQty: cols[4]||'',
        location: cols[5]||'',
        imageUrl: null
      };
      inventory.push(item);
      addRow(item);
    });
  };
  reader.readAsText(file,'UTF-8');
}

function addRow(item){
  const row = document.createElement("tr");
  row.innerHTML = `
    <td>${tbody.rows.length+1}</td>
    <td contenteditable="true">${item.code}</td>
    <td contenteditable="true">${item.name}</td>
    <td contenteditable="true">${item.spec}</td>
    <td contenteditable="true">${item.sysQty}</td>
    <td contenteditable="true">${item.realQty}</td>
    <td contenteditable="true">${item.location}</td>
    <td>
      <button class="delete-btn" onclick="deleteRow(this)">删除</button>
      <button class="upload-btn" onclick="triggerUpload(this)">上传照片</button>
      <input type="file" class="img-input" style="display:none" accept="image/*" onchange="handleImage(this)">
    </td>
  `;
  tbody.appendChild(row);
}

function deleteRow(btn){
  const row = btn.closest("tr");
  const idx = Array.from(tbody.rows).indexOf(row);
  inventory.splice(idx,1);
  tbody.removeChild(row);
  refreshIndices();
}

function refreshIndices(){
  Array.from(tbody.rows).forEach((row,i)=>{
    row.cells[0].innerText = i+1;
  });
}

function triggerUpload(btn){
  btn.nextElementSibling.click();
}

function handleImage(input){
  const file = input.files[0];
  if(file && file.type.startsWith('image/')){
    const reader = new FileReader();
    reader.onload = e=>{
      const row = input.closest("tr");
      const idx = Array.from(tbody.rows).indexOf(row);
      inventory[idx].imageUrl = e.target.result;
      input.previousElementSibling.innerText = "查看图片";
      input.previousElementSibling.onclick = ()=>openImgModal(e.target.result);
    };
    reader.readAsDataURL(file);
  }
}

function openImgModal(src){
  const modal = document.getElementById("imgModal");
  document.getElementById("modalImg").src = src;
  modal.style.display = "flex";
}

function closeImgModal(){
  document.getElementById("imgModal").style.display = "none";
}

function exportCSV(){
  let csv = "物料编号,物料名称,规格,系统数量,实际数量,存放位置\n";
  inventory.forEach(item=>{
    const escape = str => `"${(str||'').replace(/"/g,'""')}"`;
    csv += [item.code,item.name,item.spec,item.sysQty,item.realQty,item.location].map(escape).join(",") + "\n";
  });
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = "库存盘点.csv";
  a.click();
  URL.revokeObjectURL(a.href);
}
</script>
</body>
</html>