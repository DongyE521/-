<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åº“å­˜ç›˜ç‚¹ç³»ç»Ÿï¼ˆä¿®å¤ä¼˜åŒ–ç‰ˆï¼‰</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:10px; background:#f9f9f9; }
    h2 { margin-top: 0; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { border:1px solid #ccc; padding:8px; text-align:center; }
    th { background:#f0f0f0; }
    tr.duplicate { background:#ffe0e0; }
    .controls { margin:10px 0; }
    button { margin:2px; padding:6px 10px; }
    input[type="file"] { margin:5px 0; }
  </style>
</head>
<body>
  <h2>ğŸ“¦ åº“å­˜ç›˜ç‚¹ç³»ç»Ÿï¼ˆä¿®å¤ä¼˜åŒ–ç‰ˆï¼‰</h2>

  <div class="controls">
    <button onclick="addRow()">â• æ–°å¢è¡Œ</button>
    <button onclick="exportCSV()">â¬‡ï¸ å¯¼å‡º CSV</button>
    <button onclick="exportExcel()">â¬‡ï¸ å¯¼å‡º Excel</button>
    <input type="file" id="importFile" accept=".csv,.xlsx" onchange="handleImport(event)">
    <input type="text" id="searchBox" placeholder="ğŸ” æœç´¢...">
  </div>

  <table id="inventoryTable">
    <thead>
      <tr>
        <th>åºå·</th>
        <th>ç‰©æ–™ç¼–å·</th>
        <th>ç‰©æ–™æè¿°</th>
        <th>ç³»ç»Ÿæ•°é‡</th>
        <th>å®é™…æ•°é‡</th>
        <th>å¤‡æ³¨</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    let data = JSON.parse(localStorage.getItem("inventoryData") || "[]");
    let debounceTimer = null;

    // ä¿å­˜æ•°æ®
    function saveData() {
      localStorage.setItem("inventoryData", JSON.stringify(data));
    }

    // æ¸²æŸ“è¡¨æ ¼
    function renderTable(filter="") {
      const tbody = document.querySelector("#inventoryTable tbody");
      tbody.innerHTML = "";

      // é‡å¤æ£€æµ‹ï¼šç”¨ Map ç»Ÿè®¡æ–™å·æ¬¡æ•°
      const codeMap = new Map();
      data.forEach(item => {
        const code = (item.code || "").trim().toUpperCase();
        if (code) {
          codeMap.set(code, (codeMap.get(code) || 0) + 1);
        }
      });

      data.forEach((row, i) => {
        if (filter && !Object.values(row).some(v => (v || "").includes(filter))) return;
        const tr = document.createElement("tr");

        // é‡å¤æ–™å·æ ‡çº¢
        if (row.code && codeMap.get(row.code.trim().toUpperCase()) > 1) {
          tr.classList.add("duplicate");
        }

        tr.innerHTML = `
          <td>${i + 1}</td>
          <td contenteditable oninput="updateCell(${i}, 'code', this.innerText)">${row.code||""}</td>
          <td contenteditable oninput="updateCell(${i}, 'desc', this.innerText)">${row.desc||""}</td>
          <td contenteditable oninput="updateCell(${i}, 'sysQty', this.innerText)">${row.sysQty||""}</td>
          <td contenteditable oninput="updateCell(${i}, 'actQty', this.innerText)">${row.actQty||""}</td>
          <td contenteditable oninput="updateCell(${i}, 'remark', this.innerText)">${row.remark||""}</td>
          <td><button onclick="deleteRow(${i})">âŒ åˆ é™¤</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    // æ›´æ–°å•å…ƒæ ¼
    function updateCell(i, key, val) {
      data[i][key] = val;
      saveData();
      renderTable(document.querySelector("#searchBox").value.trim());
    }

    // æ–°å¢è¡Œ
    function addRow() {
      data.push({ code:"", desc:"", sysQty:"", actQty:"", remark:"" });
      saveData();
      renderTable();
    }

    // åˆ é™¤è¡Œ
    function deleteRow(i) {
      data.splice(i, 1);
      saveData();
      renderTable();
    }

    // å¯¼å‡º CSV
    function exportCSV() {
      const rows = [["åºå·","ç‰©æ–™ç¼–å·","ç‰©æ–™æè¿°","ç³»ç»Ÿæ•°é‡","å®é™…æ•°é‡","å¤‡æ³¨"]];
      data.forEach((row,i) => rows.push([i+1,row.code,row.desc,row.sysQty,row.actQty,row.remark]));
      const csv = rows.map(r=>r.map(x=>`"${x||""}"`).join(",")).join("\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "åº“å­˜ç›˜ç‚¹.csv"; a.click();
    }

    // å¯¼å‡º Excel
    function exportExcel() {
      const rows = [["åºå·","ç‰©æ–™ç¼–å·","ç‰©æ–™æè¿°","ç³»ç»Ÿæ•°é‡","å®é™…æ•°é‡","å¤‡æ³¨"]];
      data.forEach((row,i) => rows.push([i+1,row.code,row.desc,row.sysQty,row.actQty,row.remark]));
      let table = rows.map(r=>"<tr>"+r.map(x=>`<td>${x||""}</td>`).join("")+"</tr>").join("");
      const html = `<table>${table}</table>`;
      const blob = new Blob([html], {type:"application/vnd.ms-excel"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "åº“å­˜ç›˜ç‚¹.xls"; a.click();
    }

    // å¯¼å…¥ CSV
    function handleImport(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(evt) {
        const text = evt.target.result;
        const rows = text.split(/\r?\n/).map(r => r.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g));
        data = rows.slice(1).filter(r=>r).map(r => ({
          code: r[1]?.replace(/"/g,"")||"",
          desc: r[2]?.replace(/"/g,"")||"",
          sysQty: r[3]?.replace(/"/g,"")||"",
          actQty: r[4]?.replace(/"/g,"")||"",
          remark: r[5]?.replace(/"/g,"")||""
        }));
        saveData();
        renderTable();
      };
      reader.readAsText(file,"utf-8");
    }

    // æœç´¢ï¼ˆé˜²æŠ–ï¼‰
    document.querySelector("#searchBox").addEventListener("input", e=>{
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(()=>{
        renderTable(e.target.value.trim());
      }, 300);
    });

    // åˆå§‹åŒ–
    renderTable();
  </script>
</body>
</html>