<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>åº“å­˜ç›˜ç‚¹ç³»ç»Ÿ</title>
  <!-- PWA é…ç½® -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2196f3">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="åº“å­˜ç›˜ç‚¹">
  <link rel="apple-touch-icon" href="icon.png">
  <!-- å¤–éƒ¨èµ„æº -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <!-- æ ¸å¿ƒæ ·å¼ -->
  <style>
    body { 
      font-family: Arial, sans-serif; 
      padding: 10px; 
      margin: 0; 
      padding-bottom: 200px; /* åº•éƒ¨ç•™ç™½ï¼Œé¿å…å†…å®¹è¢«é®æŒ¡ */
      -webkit-overflow-scrolling: touch; 
    }
   .browser-guide { 
      background: #e6f7ff; 
      border-left: 4px solid #1890ff; 
      padding: 10px 15px; 
      margin: 15px 0; 
      border-radius: 4px; 
      font-size: 14px; 
      color: #1890ff; 
    }
   .highlight { 
      color: #096dd9; 
      font-weight: bold; 
    }
    h2 { 
      text-align: center; 
      color: #333; 
      margin: 20px 0; 
      font-size: 24px; 
    }
   .summary { 
      background: #f5f7fa; 
      padding: 10px 15px; 
      border-radius: 6px; 
      margin: 10px 0; 
      display: flex; 
      justify-content: space-between; 
      font-size: 16px; 
    }
   .summary span { 
      color: #1890ff; 
      font-weight: bold; 
    }
    table { 
      border-collapse: collapse; 
      width: 100%; 
      margin: 15px 0; 
      background: white; 
      box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
    }
    th, td { 
      border: 1px solid #eee; 
      padding: 10px 8px; 
      text-align: center; 
      font-size: 14px; 
    }
    th { 
      background-color: #fafafa; 
      font-weight: bold; 
      position: sticky; 
      top: 0; 
      z-index: 1; 
    }
    td[contenteditable] { 
      background: #fff8dc; 
      cursor: text; 
    }
    tr.duplicate { 
      background-color: #fff2f0; 
    }
    /* æŒ‰é’®æ ·å¼ */
   .delete-btn { 
      background: #ff4d4f; 
      color: white; 
      padding: 6px 12px; 
      font-size: 14px; 
      border: none; 
      border-radius: 4px; 
      cursor: pointer; 
    }
   .upload-img-btn {
      background: #4CAF50;
      color: white;
      padding: 6px 12px;
      font-size: 14px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 5px;
    }
   .view-img-btn {
      background: #2196F3;
      color: white;
      padding: 6px 12px;
      font-size: 14px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 5px;
    }
    /* åº•éƒ¨æŒ‰é’®ç»Ÿä¸€æ ·å¼ */
   .import-label { 
      flex: 1; 
      min-width: 0; 
      max-width: none; 
      height: 48px; 
      padding: 0 8px; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      font-size: clamp(12px, 3vw, 14px); 
      white-space: nowrap; 
      overflow: hidden; 
      text-overflow: ellipsis; 
      background: #1890ff; 
      color: white; 
      border-radius: 8px; 
      cursor: pointer; 
      text-align: center; 
      box-sizing: border-box; 
    }
    #fileInput, #batchFileInput, #materialLibFileInput, 
   .img-file-input { 
      display: none; 
    }
   .batch-upload { 
      margin: 15px 0; 
      padding: 15px; 
      background: #f9f9f9; 
      border-radius: 8px; 
    }
   .batch-label { 
      display: inline-block; 
      padding: 10px 15px; 
      background: #faad14; 
      color: white; 
      border-radius: 6px; 
      cursor: pointer; 
      font-size: 15px; 
      margin-right: 10px; 
    }
    /* æœç´¢æ æ ·å¼ */
   .search-bar { 
      position: fixed; 
      bottom: 68px; 
      left: 0; 
      right: 0; 
      padding: 10px 15px; 
      background: white; 
      border-top: 1px solid #eee; 
      display: flex; 
      justify-content: center; 
      box-shadow: 0 -2px 5px rgba(0,0,0,0.03); 
      z-index: 10; 
    }
   .search-bar input { 
      width: calc(100% - 40px); 
      padding: 12px 15px; 
      border: 1px solid #ddd; 
      border-radius: 8px; 
      font-size: 15px; 
      min-height: 45px; 
      box-sizing: border-box; 
    }
    /* åº•éƒ¨æ“ä½œæ å®¹å™¨ */
   .bottom-actions { 
      display: flex; 
      flex-wrap: nowrap; 
      justify-content: space-between; 
      align-items: center; 
      gap: 8px; 
      padding: 10px; 
      background: white; 
      border-top: 1px solid #eee; 
      box-sizing: border-box; 
      position: fixed; 
      bottom: 0; 
      left: 0; 
      right: 0; 
      z-index: 10; 
    }
    /* åº•éƒ¨æŒ‰é’®æ ·å¼ */
   .primary-btn { 
      flex: 1; 
      min-width: 0; 
      max-width: none; 
      height: 48px; 
      padding: 0 8px; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      font-size: clamp(12px, 3vw, 14px); 
      white-space: nowrap; 
      overflow: hidden; 
      text-overflow: ellipsis; 
      background-color: #1890ff; 
      color: white; 
      border: none; 
      border-radius: 8px; 
      cursor: pointer; 
      box-sizing: border-box; 
    }
    /* æ»šåŠ¨æŒ‰é’® */
   .scroll-btn { 
      position: fixed; 
      width: 50px; 
      height: 50px; 
      border-radius: 50%; 
      background: #1890ff; 
      color: white; 
      border: none; 
      font-size: 24px; 
      cursor: pointer; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.2); 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      z-index: 5; 
      opacity: 0.9; 
    }
   .to-top { 
      bottom: 180px; 
      right: 15px; 
    }
   .to-bottom { 
      bottom: 115px; 
      right: 15px; 
    }
        /* å¯¼å‡ºç›¸å…³æ ·å¼ï¼ˆå·²éšè—é¢„è§ˆæ¡†ï¼‰ */
   .csv-container { 
      display: none; /* éšè—é¢„è§ˆæ¡† */
      background: #f8f9fa; 
      border: 1px solid #ddd; 
      border-radius: 6px; 
      padding: 15px; 
      margin: 15px 0; 
      max-height: 200px; 
      overflow-y: auto; 
      font-family: monospace; 
      font-size: 14px; 
      white-space: pre-wrap; 
    }
   .copy-btn { 
      display: none; /* éšè—å¤åˆ¶æŒ‰é’® */
      background: #52c41a; 
      color: white; 
      border: none; 
      padding: 8px 16px; 
      border-radius: 4px; 
      cursor: pointer; 
      font-size: 15px; 
      margin: 10px 0; 
    }
    /* æç¤ºæ¶ˆæ¯æ¡† */
   .tip { 
      position: fixed; 
      top: 20px; 
      left: 50%; 
      transform: translateX(-50%); 
      padding: 12px 20px; 
      border-radius: 6px; 
      color: white; 
      background: #52c41a; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.15); 
      z-index: 100; 
      display: none; 
      font-size: 16px; 
      max-width: 80%; 
      text-align: center; 
    }
    /* å¼¹çª—æ ·å¼ */
   .modal { 
      position: fixed; 
      top: 0; 
      left: 0; 
      right: 0; 
      bottom: 0; 
      background: rgba(0,0,0,0.5); 
      display: none; 
      justify-content: center; 
      align-items: center; 
      z-index: 1000; 
    }
   .modal-content { 
      background: white; 
      padding: 25px; 
      border-radius: 10px; 
      width: 80%; 
      max-width: 300px; 
    }
   .modal-title { 
      font-size: 18px; 
      margin: 0 0 20px 0; 
      text-align: center; 
    }
   .modal-select { 
      width: 100%; 
      padding: 12px; 
      border: 1px solid #ddd; 
      border-radius: 6px; 
      font-size: 16px; 
      margin-bottom: 20px; 
      box-sizing: border-box; 
    }
   .modal-buttons { 
      display: flex; 
      gap: 10px; 
    }
   .modal-btn { 
      flex: 1; 
      padding: 12px; 
      border-radius: 6px; 
      border: none; 
      font-size: 16px; 
      cursor: pointer; 
    }
   .modal-cancel { 
      background: #f5f5f5; 
    }
   .modal-confirm { 
      background: #1890ff; 
      color: white; 
    }
    #exportArea { 
      display: none; /* å½»åº•éšè—å¯¼å‡ºé¢„è§ˆåŒºåŸŸ */
    }
    /* å›¾ç‰‡é¢„è§ˆå¼¹çª— */
   .img-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      padding: 20px;
    }
   .img-modal-content {
      max-width: 90%;
      max-height: 90%;
      border: 4px solid white;
      border-radius: 8px;
    }
   .img-modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      color: white;
      font-size: 30px;
      cursor: pointer;
    }
    /* CSV æ ¼å¼æç¤º */
   .csv-tip {
      font-size: 13px;
      color: #666;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <!-- æµè§ˆå™¨é€‚é…æç¤º -->
  <div class="browser-guide">
    <p>ğŸŒ <span class="highlight">ä½¿ç”¨æç¤ºï¼š</span>å…ˆä¸Šä¼ ç‰©æ–™åº“CSVï¼Œæ–°å¢ç‰©æ–™æ—¶è¾“å…¥æ–™å·/å‹å·å¯è‡ªåŠ¨å¡«å……ä¿¡æ¯</p>
  </div>
  
  <!-- æ ‡é¢˜ä¸ç»Ÿè®¡ä¿¡æ¯ -->
  <h2>ğŸ“¦ åº“å­˜ç›˜ç‚¹ç³»ç»Ÿ</h2>
  <div class="summary">
    <div>æ€»ç‰©æ–™ç§ç±»æ•°ï¼š<span id="totalCount">0</span></div>
    <div>å·²ç›˜ç‚¹ç‰©æ–™ç§ç±»æ•°ï¼š<span id="countedCount">0</span></div>
  </div>
  
  <!-- æ‰¹é‡å¯¼å…¥åŒºåŸŸ -->
  <div class="batch-upload">
    <p>æ‰¹é‡è¿½åŠ ç›˜ç‚¹æ•°æ®ï¼ˆCSVæ ¼å¼ï¼‰ï¼š</p>
    <label for="batchFileInput" class="batch-label">é€‰æ‹©ç›˜ç‚¹CSV</label>
    <input type="file" id="batchFileInput" accept=".csv">
    <span style="font-size:14px; color:#666;">æ ¼å¼ï¼šç‰©æ–™ç¼–å·,ç‰©æ–™åç§°,è§„æ ¼,ç³»ç»Ÿæ•°é‡,å®é™…æ•°é‡,å­˜æ”¾ä½ç½®</span>
    <p class="csv-tip">æ³¨æ„ï¼šè‹¥å­—æ®µå«é€—å·ï¼Œè¯·ç”¨åŒå¼•å·åŒ…è£¹ï¼ˆå¦‚ "åç§°,å¸¦é€—å·"ï¼‰</p>
  </div>
  
  <!-- ç‰©æ–™åº“å•ç‹¬ä¸Šä¼ åŒºåŸŸ -->
  <div class="batch-upload" style="background:#e6f7ff;">
    <p>ğŸ“š ç‰©æ–™åº“ç®¡ç†ï¼ˆä»…ç”¨äºè‡ªåŠ¨å¡«å……ï¼‰ï¼š</p>
    <label for="materialLibFileInput" class="batch-label" style="background:#52c41a;">ä¸Šä¼ ç‰©æ–™åº“CSV</label>
    <input type="file" id="materialLibFileInput" accept=".csv">
    <button class="batch-label" style="background:#faad14;" onclick="clearMaterialLib()">æ¸…ç©ºç‰©æ–™åº“</button>
    <span style="font-size:14px; color:#666;">ç‰©æ–™åº“æ ¼å¼ï¼šç‰©æ–™ç¼–å·,ç‰©æ–™åç§°,è§„æ ¼ï¼ˆä»…è¿™ä¸‰åˆ—ï¼‰</span>
    <p style="margin:8px 0 0 0; font-size:14px;">å½“å‰ç‰©æ–™åº“æ•°é‡ï¼š<span id="materialLibCount">0</span> ç§</p>
  </div>
  
  <!-- åº“å­˜è¡¨æ ¼ï¼ˆä½¿ç”¨ä½ æä¾›çš„åŸå§‹è¡¨å¤´ï¼‰ -->
  <table id="inventoryTable">
    <thead>
      <tr>
        <th>åºå·</</th>
        <th>ç‰©æ–™ç¼–å·</</th>
        <th>ç‰©æ–™åç§°</</th>
        <th>è§„æ ¼</</th>
        <th>ç³»ç»Ÿæ•°é‡</</th>
        <th>å®é™…æ•°é‡</</th>
        <th>å­˜æ”¾ä½ç½®</</th>
        <th>çŠ¶æ€</</th>
        <th>æ“ä½œ</</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>...
    <!-- æœç´¢æ  -->
  <div class="search-bar">
    <input type="text" id="searchInput" placeholder="æœç´¢ç‰©æ–™ç¼–å·/åç§°/è§„æ ¼...">
  </div>
  
  <!-- åº•éƒ¨æ“ä½œæŒ‰é’® -->
  <div class="bottom-actions">
    <label for="fileInput" class="import-label">é‡æ–°å¯¼å…¥</label>
    <input type="file" id="fileInput" accept=".csv">
    <button class="primary-btn" onclick="showFormatModal()">å¯¼å‡ºæ–‡ä»¶</button>
    <button class="primary-btn" onclick="addNewItem()">æ–°å¢ç‰©æ–™</button>
    <button class="primary-btn" onclick="undoLastAction()">æ’¤å›ä¸Šä¸€æ­¥</button>
  </div>
  
  <!-- æ»šåŠ¨æŒ‰é’® -->
  <button class="scroll-btn to-top" onclick="scrollToTop()">â†‘</button>
  <button class="scroll-btn to-bottom" onclick="scrollToBottom()">â†“</button>
  
  <!-- å¯¼å‡ºæ ¼å¼é€‰æ‹©å¼¹çª— -->
  <div class="modal" id="formatModal">
    <div class="modal-content">
      <p class="modal-title">é€‰æ‹©å¯¼å‡ºæ ¼å¼</p>
      <select class="modal-select" id="exportFormat">
        <option value="csv">CSVæ ¼å¼</option>
        <option value="excel">Excelæ ¼å¼</option>
      </select>
      <div class="modal-buttons">
        <button class="modal-btn modal-cancel" onclick="closeFormatModal()">å–æ¶ˆ</button>
        <button class="modal-btn modal-confirm" onclick="confirmExportFormat()">ç¡®è®¤å¯¼å‡º</button>
      </div>
    </div>
  </div>
  
  <!-- å›¾ç‰‡é¢„è§ˆå¼¹çª— -->
  <div class="img-modal" id="imgModal">
    <span class="img-modal-close" onclick="closeImageModal()">&times;</span>
    <img class="img-modal-content" id="modalImage">
  </div>
  
  <!-- æç¤ºæ¶ˆæ¯æ¡† -->
  <div class="tip" id="tip"></div>
  <!-- Service Worker æ³¨å†Œ -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js', { scope: './' })
         .then(reg => console.log("Service Worker æ³¨å†ŒæˆåŠŸ", reg))
         .catch(err => console.log("Service Worker æ³¨å†Œå¤±è´¥", err));
      });
    }
  </script>
  <!-- æ ¸å¿ƒåŠŸèƒ½è„šæœ¬ -->
  <script>
    // é˜²æŠ–å‡½æ•°ï¼šå»¶è¿Ÿæ‰§è¡Œï¼Œé¿å…é¢‘ç¹è§¦å‘
    function debounce(func, delay) {
      let timer;
      return function() {
        clearTimeout(timer);
        timer = setTimeout(() => {
          func.apply(this, arguments);
        }, delay);
      };
    }
    // å…¨å±€å˜é‡ï¼šç‰©æ–™åº“ä¸ç›˜ç‚¹æ•°æ®å®Œå…¨åˆ†ç¦»
    let inventory = JSON.parse(localStorage.getItem("inventory")) || []; // ç›˜ç‚¹æ¸…å•æ•°æ®
    let materialMap = JSON.parse(localStorage.getItem("materialMap")) || {}; // ç‰©æ–™åº“ï¼ˆå•ç‹¬å­˜å‚¨ï¼‰
    let operationHistory = []; // æ“ä½œå†å²ï¼ˆç”¨äºæ’¤å›ï¼‰
    let currentSearchKeyword = "";
    let pendingImportFile = null;

    // DOM å…ƒç´ ç¼“å­˜
    const tbody = document.querySelector("#inventoryTable tbody");
    const totalCountEl = document.getElementById("totalCount");
    const countedCountEl = document.getElementById("countedCount");
    const tipEl = document.getElementById("tip");
    const searchInput = document.getElementById("searchInput");
    const formatModal = document.getElementById("formatModal");
    // ç‰©æ–™åº“ç›¸å…³å…ƒç´ 
    const materialLibFileInput = document.getElementById("materialLibFileInput");
    const materialLibCountEl = document.getElementById("materialLibCount");

    // é¡µé¢åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      // åŠ è½½ç‰©æ–™åº“å¹¶æ›´æ–°è®¡æ•°
      updateMaterialLibCount();
      // ç»‘å®šç‰©æ–™åº“ä¸Šä¼ äº‹ä»¶
      materialLibFileInput.addEventListener("change", handleMaterialLibImport);
      // åŸæœ‰åˆå§‹åŒ–é€»è¾‘
      renderTable();
      updateSummary();
      searchInput.addEventListener('input', handleSearch);
      document.getElementById("batchFileInput").addEventListener("change", handleBatchImport);
      document.getElementById("fileInput").addEventListener("change", handleFullImport);
    });

    // æœç´¢åŠŸèƒ½
    function handleSearch(e) {
      currentSearchKeyword = e.target.value.toLowerCase().trim();
      renderTable();
    }

    // æ¸²æŸ“è¡¨æ ¼
    function renderTable() {
      let data = [...inventory];
      // æœç´¢è¿‡æ»¤
      if (currentSearchKeyword) {
        data = data.filter(item => {
          const code = (item.code || "").toLowerCase();
          const name = (item.name || "").toLowerCase();
          const spec = (item.spec || "").toLowerCase();
          const location = (item.location || "").toLowerCase();
          return code.includes(currentSearchKeyword) || 
                 name.includes(currentSearchKeyword) || 
                 spec.includes(currentSearchKeyword) || 
                 location.includes(currentSearchKeyword);
        });
      }
      // æ¸…ç©ºå¹¶å¡«å……è¡¨æ ¼
      tbody.innerHTML = "";
      data.forEach((item, index) => {
        const row = document.createElement("tr");
        if (item.duplicate) row.classList.add("duplicate");
        row.innerHTML = `
          <td>${index + 1}</td>
          <td contenteditable="true" onblur="updateField(${inventory.indexOf(item)}, 'code', this.innerText)">${item.code}</td>
          <td contenteditable="true" onblur="updateField(${inventory.indexOf(item)}, 'name', this.innerText)">${item.name}</td>
          <td contenteditable="true" onblur="updateField(${inventory.indexOf(item)}, 'spec', this.innerText)">${item.spec}</td>
          <td contenteditable="true" onblur="updateField(${inventory.indexOf(item)}, 'sysQty', this.innerText)">${item.sysQty}</td>
          <td contenteditable="true" onblur="updateField(${inventory.indexOf(item)}, 'realQty', this.innerText)">${item.realQty}</td>
          <td contenteditable="true" onblur="updateField(${inventory.indexOf(item)}, 'location', this.innerText)">${item.location}</td>
          <td>${item.duplicate? '<span style="color:#f5222d;">é‡å¤</span>' : 'æ­£å¸¸'}</td>
          <td>
            <button class="delete-btn" onclick="deleteRow(${inventory.indexOf(item)})">åˆ é™¤</button>
            ${item.imageUrl? 
              `<button class="view-img-btn" onclick="openImageModal('${item.imageUrl}')">æŸ¥çœ‹å›¾ç‰‡</button>` : 
              `<label class="upload-img-btn" for="imgInput-${inventory.indexOf(item)}">ä¸Šä¼ å›¾ç‰‡</label>
               <input type="file" id="imgInput-${inventory.indexOf(item)}" class="img-file-input" accept="image/*" onchange="handleImageUpload(${inventory.indexOf(item)}, this)">`
            }
          </td>
        `;
        tbody.appendChild(row);
      });
      // ä¿å­˜æ•°æ®å¹¶æ›´æ–°ç»Ÿè®¡
      localStorage.setItem("inventory", JSON.stringify(inventory));
      updateSummary();
    }
        // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
    function handleImageUpload(index, input) {
      const file = input.files[0];
      if (!file) return;
      
      // éªŒè¯æ–‡ä»¶ç±»å‹
      if (!file.type.startsWith('image/')) {
        showTip("è¯·ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶", "error");
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        // ä¿å­˜å›¾ç‰‡URLåˆ°å¯¹åº”ç‰©æ–™
        inventory[index].imageUrl = e.target.result;
        localStorage.setItem("inventory", JSON.stringify(inventory));
        renderTable(); // é‡æ–°æ¸²æŸ“è¡¨æ ¼æ˜¾ç¤º"æŸ¥çœ‹å›¾ç‰‡"æŒ‰é’®
        showTip("å›¾ç‰‡ä¸Šä¼ æˆåŠŸ");
      };
      reader.readAsDataURL(file);
    }

    // æ‰“å¼€å›¾ç‰‡é¢„è§ˆå¼¹çª—
    function openImageModal(imageUrl) {
      const modal = document.getElementById('imgModal');
      const modalImg = document.getElementById('modalImage');
      modalImg.src = imageUrl;
      modal.style.display = 'flex';
    }

    // å…³é—­å›¾ç‰‡é¢„è§ˆå¼¹çª—
    function closeImageModal() {
      document.getElementById('imgModal').style.display = 'none';
    }

    // æ›´æ–°ç‰©æ–™å­—æ®µï¼ˆå¢å¼ºé‡å¤æ£€æµ‹ï¼‰
    function updateField(index, field, value) {
      if (inventory[index]) {
        value = value || "";
        inventory[index][field] = value;

        // ç¼–è¾‘æ–™å·æ—¶è‡ªåŠ¨å¡«å……åç§°å’Œå‹å·ï¼ˆä»…å½“åç§°/å‹å·ä¸ºç©ºæ—¶ï¼‰
        if (field === "code") {
          const code = value.trim();
          const item = inventory[index];
          if (materialMap[code] && (!item.name ||!item.spec)) {
            item.name = item.name || materialMap[code].name; // ä¿ç•™æ‰‹åŠ¨è¾“å…¥
            item.spec = item.spec || materialMap[code].spec; // ä¿ç•™æ‰‹åŠ¨è¾“å…¥
            showTip(`å·²è‡ªåŠ¨æ›´æ–°æ–™å·ã€Œ${code}ã€çš„ä¿¡æ¯`);
          }
          
          // æ–™å·å˜æ›´æ—¶ç«‹å³å…¨é¢æ£€æŸ¥é‡å¤é¡¹
          checkAllDuplicates();
        }

        localStorage.setItem("inventory", JSON.stringify(inventory));
        renderTable();
        updateSummary();
      }
    }

    // æ–°å¢ç‰©æ–™ï¼ˆæ‰‹æœºç«¯ä¼˜åŒ–ï¼š1.5ç§’å»¶è¿Ÿè¯†åˆ«ï¼‰
    function addNewItem() {
      const newId = `WL${Date.now().toString().slice(-6)}`; 
      const newItem = {
        code: newId,
        name: "",
        spec: "",
        sysQty: "0",
        realQty: "",
        location: "",
        duplicate: false,
        imageUrl: null  // æ–°å¢å›¾ç‰‡URLå±æ€§
      };
      inventory.push(newItem);
      checkAllDuplicates(); // æ–°å¢åæ£€æŸ¥é‡å¤é¡¹
      renderTable(); // å…ˆæ¸²æŸ“ï¼Œç¡®ä¿è¡Œç´¢å¼•æ­£ç¡®
      showTip("æ–°å¢ç‰©æ–™è¡Œï¼šè¾“å…¥æ–™å·/å‹å·åç¨ç­‰è‡ªåŠ¨å¡«å……");
      scrollToBottom();

      // ç›‘å¬æ–°å¢è¡Œçš„è¾“å…¥äº‹ä»¶ï¼ˆæ‰‹æœºç«¯é€‚é…ï¼‰
      setTimeout(() => {
        const rows = tbody.querySelectorAll("tr");
        const lastRow = rows[rows.length - 1];
        const rowIndex = Array.from(rows).indexOf(lastRow); // è·å–å½“å‰è¡Œç´¢å¼•
        const codeInput = lastRow.querySelector("td:nth-child(2)"); 
        const nameInput = lastRow.querySelector("td:nth-child(3)"); 
        const specInput = lastRow.querySelector("td:nth-child(4)"); 

        let codeAutoFilled = false;
        let specAutoFilled = false;

        // æ–™å·è¾“å…¥ï¼š1.5ç§’æ— æ“ä½œåè§¦å‘ + é•¿åº¦â‰¥3æ‰è¯†åˆ«ï¼ˆé¿å…çŸ­å­—ç¬¦è¯¯è§¦å‘ï¼‰
        codeInput.addEventListener("input", debounce(function() {
          const code = codeInput.innerText.trim();
          // æ‰‹æœºç«¯ä¼˜åŒ–ï¼šæ–™å·è‡³å°‘è¾“å…¥3ä¸ªå­—ç¬¦æ‰å°è¯•åŒ¹é…
          if (!codeAutoFilled && code.length >= 3 && materialMap[code] && rowIndex > -1) {
            inventory[rowIndex].name = materialMap[code].name;
            inventory[rowIndex].spec = materialMap[code].spec;
            codeAutoFilled = true; // åªå¡«å……ä¸€æ¬¡ï¼Œé¿å…é‡å¤è§¦å‘
            localStorage.setItem("inventory", JSON.stringify(inventory));
            renderTable(); // é‡æ–°æ¸²æŸ“ç¡®ä¿æ˜¾ç¤º
            showTip(`å·²è‡ªåŠ¨å¡«å……æ–™å·ã€Œ${code}ã€`);
          }
        }, 1500)); // 1.5ç§’å»¶è¿Ÿ

        // å‹å·è¾“å…¥ï¼š1.5ç§’æ— æ“ä½œåè§¦å‘ + é•¿åº¦â‰¥2æ‰è¯†åˆ«
        specInput.addEventListener("input", debounce(function() {
          const spec = specInput.innerText.trim().toLowerCase();
          // æ‰‹æœºç«¯ä¼˜åŒ–ï¼šå‹å·è‡³å°‘è¾“å…¥2ä¸ªå­—ç¬¦æ‰å°è¯•åŒ¹é…
          if (!specAutoFilled && spec.length >= 2 && rowIndex > -1) {
            for (const code in materialMap) {
              // ä¸¥æ ¼åŒ¹é…å‹å·ï¼ˆå…¨åŒ…å«è€Œééƒ¨åˆ†åŒ¹é…ï¼‰
              if (materialMap[code].spec.toLowerCase().includes(spec)) {
                inventory[rowIndex].code = code;
                inventory[rowIndex].name = materialMap[code].name;
                inventory[rowIndex].spec = materialMap[code].spec;
                specAutoFilled = true; // åªå¡«å……ä¸€æ¬¡
                localStorage.setItem("inventory", JSON.stringify(inventory));
                renderTable(); // é‡æ–°æ¸²æŸ“ç¡®ä¿æ˜¾ç¤º
                showTip(`å·²åŒ¹é…å‹å·ã€Œ${spec}ã€â†’ æ–™å·ã€Œ${code}ã€`);
                break;
              }
            }
          }
        }, 1500)); // 1.5ç§’å»¶è¿Ÿ

        // æ‰‹åŠ¨ä¿®æ”¹åç§°æ—¶ï¼Œå–æ¶ˆè‡ªåŠ¨å¡«å……æ ‡è®°ï¼ˆé¿å…è¦†ç›–æ‰‹åŠ¨è¾“å…¥ï¼‰
        nameInput.addEventListener("input", function() {
          codeAutoFilled = true;
          specAutoFilled = true;
        });
      }, 100);
    }

    // åˆ é™¤ç‰©æ–™è¡Œ
    function deleteRow(index) {
      const deletedItem = inventory[index];
      if (!deletedItem) return;
      inventory.splice(index, 1);
      checkAllDuplicates(); // åˆ é™¤åé‡æ–°æ£€æµ‹é‡å¤é¡¹
      // è®°å½•åˆ é™¤æ“ä½œåˆ°å†å²
      operationHistory.push({ 
        type: 'delete', 
        index: index, 
        item: deletedItem 
      }); 
      renderTable();
      showTip(`å·²åˆ é™¤ã€Œ${deletedItem.name || 'æœªå‘½åç‰©æ–™'}ã€`);
    }

    // æ’¤å›ä¸Šä¸€æ­¥æ“ä½œ
    function undoLastAction() {
      if (operationHistory.length === 0) {
        showTip("æ²¡æœ‰å¯æ’¤å›çš„æ“ä½œ", "error");
        return;
      }
      const lastOp = operationHistory.pop();
      if (lastOp.type === 'delete') {
        inventory.splice(lastOp.index, 0, lastOp.item); 
        checkAllDuplicates(); // æ¢å¤åæ£€æŸ¥é‡å¤é¡¹
        localStorage.setItem("inventory", JSON.stringify(inventory));
        renderTable();
        showTip(`å·²æ¢å¤ã€Œ${lastOp.item.name || 'æœªå‘½åç‰©æ–™'}ã€`);
      }
    }

    // æ‰¹é‡æ£€æŸ¥é‡å¤ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
    function checkAllDuplicates() {
      // å…ˆæ¸…ç©ºæ‰€æœ‰é‡å¤æ ‡è®°
      inventory.forEach(item => item.duplicate = false);
      
      // å»ºç«‹æ–™å·é¢‘ç‡æ˜ å°„è¡¨ï¼Œæ–™å·å»é™¤å‰åç©ºæ ¼å¹¶ç»Ÿä¸€è½¬ä¸ºå¤§å†™ï¼ˆå¢å¼ºåŒ¹é…åº¦ï¼‰
      const codeFrequency = {};
      inventory.forEach(item => {
        const code = (item.code || "").trim().toUpperCase();
        if (code) { // ä»…å¯¹éç©ºæ–™å·è¿›è¡Œé‡å¤æ£€æŸ¥
          codeFrequency[code] = (codeFrequency[code] || 0) + 1;
        }
      });
      
      // æ ‡è®°é‡å¤é¡¹ï¼ˆå‡ºç°æ¬¡æ•°â‰¥2çš„æ–™å·ï¼‰ï¼Œæ–™å·å¤„ç†ä¸ç»Ÿè®¡æ—¶ä¸€è‡´
      inventory.forEach(item => {
        const code = (item.code || "").trim().toUpperCase();
        if (code && codeFrequency[code] >= 2) {
          item.duplicate = true;
        }
      });
    }
        // ç‰©æ–™åº“ç®¡ç†åŠŸèƒ½
    function handleMaterialLibImport(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (event) {
        try {
          const content = event.target.result;
          // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åˆ†å‰² CSV è¡Œï¼Œæ­£ç¡®å¤„ç†å¸¦å¼•å·ä¸”å«é€—å·çš„å­—æ®µ
          const lines = content.match(/(".*?"|[^",\n]+)(?=\s*,|\s*\n)/g) || [];
          let parsedLines = [];
          let currentLine = [];
          let inQuotes = false;
          let temp = '';

          for (let i = 0; i < lines.length; i++) {
            let part = lines[i].trim();
            if (part.startsWith('"') && part.endsWith('"')) {
              // å¤„ç†å®Œæ•´çš„å¸¦å¼•å·å­—æ®µï¼ˆæ— é€—å·ï¼‰
              currentLine.push(part.slice(1, -1).replace(/""/g, '"'));
            } else if (part.startsWith('"')) {
              // å¼€å§‹å¤„ç†å¸¦å¼•å·ä¸”å«é€—å·çš„å­—æ®µ
              inQuotes = true;
              temp = part.slice(1);
            } else if (inQuotes && part.endsWith('"')) {
              // ç»“æŸå¤„ç†å¸¦å¼•å·ä¸”å«é€—å·çš„å­—æ®µ
              temp += ',' + part.slice(0, -1);
              currentLine.push(temp.replace(/""/g, '"'));
              inQuotes = false;
              temp = '';
            } else if (inQuotes) {
              // æ‹¼æ¥å¸¦å¼•å·ä¸”å«é€—å·çš„å­—æ®µä¸­é—´éƒ¨åˆ†
              temp += ',' + part;
            } else {
              // æ™®é€šå­—æ®µï¼ˆä¸å«å¼•å·å’Œé€—å·ï¼‰
              currentLine.push(part);
            }

            // ä¸€è¡Œç»“æŸï¼ˆé€šè¿‡é€—å·åˆ†å‰²åï¼Œåˆ—æ•°ç¬¦åˆé¢„æœŸæˆ–é‡åˆ°æ¢è¡Œï¼‰
            if (!inQuotes && (currentLine.length >= 3 || (i === lines.length - 1))) {
              parsedLines.push(currentLine);
              currentLine = [];
            }
          }

          if (parsedLines.length === 0) {
            showTip("ç‰©æ–™åº“æ–‡ä»¶ä¸ºç©ºæˆ–æ ¼å¼é”™è¯¯", "error");
            return;
          }

          // è§£æç‰©æ–™åº“CSVï¼ˆä»…ä¿ç•™ï¼šç¼–å·,åç§°,è§„æ ¼ï¼‰
          const newMaterialMap = {};
          let headerSkipped = false;

          parsedLines.forEach((cols, i) => {
            // è·³è¿‡è¡¨å¤´è¡Œï¼ˆåŒ¹é…å¸¸è§è¡¨å¤´å…³é”®è¯ï¼‰
            if (!headerSkipped && (cols[0] === "ç‰©æ–™ç¼–å·" || cols[0] === "åºå·" || cols[0].toLowerCase() === "code")) {
              headerSkipped = true;
              return;
            }
            if (cols.length >= 3 && cols[0]) { // å¿…é¡»åŒ…å«ç¼–å·ã€åç§°ã€è§„æ ¼
              newMaterialMap[cols[0]] = {
                name: cols[1] || "",
                spec: cols[2] || ""
              };
            }
          });
          // åˆå¹¶åˆ°ç°æœ‰ç‰©æ–™åº“ï¼ˆå»é‡ï¼Œæ–°æ•°æ®è¦†ç›–æ—§æ•°æ®ï¼‰
          Object.assign(materialMap, newMaterialMap);
          // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
          localStorage.setItem("materialMap", JSON.stringify(materialMap));
          updateMaterialLibCount();
          showTip(`ç‰©æ–™åº“ä¸Šä¼ æˆåŠŸï¼šæ–°å¢/æ›´æ–° ${Object.keys(newMaterialMap).length} ç§ç‰©æ–™`);
        } catch (err) {
          showTip("ç‰©æ–™åº“å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ ¼å¼", "error");
          console.error(err);
        }
        this.value = ""; // é‡ç½®æ–‡ä»¶è¾“å…¥
      };
      reader.readAsText(file, "UTF-8");
    }

    // æ¸…ç©ºç‰©æ–™åº“
    function clearMaterialLib() {
      if (confirm("ç¡®å®šè¦æ¸…ç©ºç‰©æ–™åº“å—ï¼Ÿæ‰€æœ‰è‡ªåŠ¨å¡«å……è§„åˆ™å°†å¤±æ•ˆï¼")) {
        materialMap = {};
        localStorage.setItem("materialMap", JSON.stringify(materialMap));
        updateMaterialLibCount();
        showTip("ç‰©æ–™åº“å·²æ¸…ç©º");
      }
    }

    // æ›´æ–°ç‰©æ–™åº“è®¡æ•°
    function updateMaterialLibCount() {
      const count = Object.keys(materialMap).length;
      materialLibCountEl.textContent = count;
    }

    // å¤„ç†æ‰¹é‡å¯¼å…¥ï¼ˆè¿½åŠ æ•°æ®ï¼‰
    function handleBatchImport(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (event) {
        try {
          const content = event.target.result;
          const lines = content.split('\n');
          let importedCount = 0;
          
          lines.forEach((line, index) => {
            if (index === 0) return; // è·³è¿‡è¡¨å¤´è¡Œ
            if (!line.trim()) return; // è·³è¿‡ç©ºè¡Œ
            
            // å¤„ç†å¸¦å¼•å·çš„å­—æ®µï¼ˆå«é€—å·ï¼‰
            const regex = /(".*?"|[^",]+)(?=\s*,|\s*$)/g;
            const cols = [];
            let match;
            while ((match = regex.exec(line))!== null) {
              cols.push(match[1].replace(/^"/, '').replace(/"$/, '').replace(/""/g, '"').trim());
            }
            
            if (cols.length >= 6) { // è‡³å°‘åŒ…å«6ä¸ªå­—æ®µ
              inventory.push({
                code: cols[0] || "",
                name: cols[1] || "",
                spec: cols[2] || "",
                sysQty: cols[3] || "0",
                realQty: cols[4] || "",
                location: cols[5] || "",
                duplicate: false,
                imageUrl: null
              });
              importedCount++;
            }
          });
          
          checkAllDuplicates(); // å¯¼å…¥åæ£€æŸ¥é‡å¤é¡¹
          localStorage.setItem("inventory", JSON.stringify(inventory));
          renderTable();
          showTip(`æ‰¹é‡å¯¼å…¥æˆåŠŸï¼šæ–°å¢ ${importedCount} æ¡æ•°æ®`);
        } catch (err) {
          showTip("æ‰¹é‡å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥CSVæ ¼å¼", "error");
          console.error(err);
        }
        this.value = ""; // é‡ç½®æ–‡ä»¶è¾“å…¥
      };
      reader.readAsText(file, "UTF-8");
    }

    // å¤„ç†å…¨é‡å¯¼å…¥ï¼ˆè¦†ç›–æ•°æ®ï¼‰
    function handleFullImport(e) {
      const file = e.target.files[0];
      if (!file) return;
      if (!confirm("å…¨é‡å¯¼å…¥å°†è¦†ç›–ç°æœ‰æ•°æ®ï¼Œç¡®å®šç»§ç»­ï¼Ÿ")) {
        this.value = "";
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function (event) {
        try {
          const content = event.target.result;
          const lines = content.split('\n');
          const newInventory = [];
          
          lines.forEach((line, index) => {
            if (index === 0) return; // è·³è¿‡è¡¨å¤´è¡Œ
            if (!line.trim()) return; // è·³è¿‡ç©ºè¡Œ
            
            // å¤„ç†å¸¦å¼•å·çš„å­—æ®µï¼ˆå«é€—å·ï¼‰
            const regex = /(".*?"|[^",]+)(?=\s*,|\s*$)/g;
            const cols = [];
            let match;
            while ((match = regex.exec(line))!== null) {
              cols.push(match[1].replace(/^"/, '').replace(/"$/, '').replace(/""/g, '"').trim());
            }
            
            if (cols.length >= 6) { // è‡³å°‘åŒ…å«6ä¸ªå­—æ®µ
              newInventory.push({
                code: cols[0] || "",
                name: cols[1] || "",
                spec: cols[2] || "",
                sysQty: cols[3] || "0",
                realQty: cols[4] || "",
                location: cols[5] || "",
                duplicate: false,
                imageUrl: null
              });
            }
          });
          
          // æ›¿æ¢ç°æœ‰æ•°æ®
          inventory = newInventory;
          checkAllDuplicates(); // å¯¼å…¥åæ£€æŸ¥é‡å¤é¡¹
          localStorage.setItem("inventory", JSON.stringify(inventory));
          renderTable();
          showTip(`å…¨é‡å¯¼å…¥æˆåŠŸï¼šå…± ${newInventory.length} æ¡æ•°æ®`);
        } catch (err) {
          showTip("å…¨é‡å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥CSVæ ¼å¼", "error");
          console.error(err);
        }
        this.value = ""; // é‡ç½®æ–‡ä»¶è¾“å…¥
      };
      reader.readAsText(file, "UTF-8");
    }
        // æ˜¾ç¤ºå¯¼å‡ºæ ¼å¼é€‰æ‹©å¼¹çª—
    function showFormatModal() {
      formatModal.style.display = 'flex';
    }

    // å…³é—­å¯¼å‡ºæ ¼å¼é€‰æ‹©å¼¹çª—
    function closeFormatModal() {
      formatModal.style.display = 'none';
    }

    // ç¡®è®¤å¯¼å‡ºæ ¼å¼å¹¶æ‰§è¡Œå¯¼å‡º
    function confirmExportFormat() {
      const format = document.getElementById("exportFormat").value;
      if (format === "csv") {
        exportToCSV();
      } else if (format === "excel") {
        exportToExcel();
      }
      closeFormatModal();
    }

    // å¯¼å‡ºä¸ºCSV
    function exportToCSV() {
      if (inventory.length === 0) {
        showTip("æ²¡æœ‰æ•°æ®å¯å¯¼å‡º", "error");
        return;
      }

      // æ„å»ºCSVå†…å®¹ï¼ˆåŒ…å«è¡¨å¤´ï¼‰
      let csvContent = "åºå·,ç‰©æ–™ç¼–å·,ç‰©æ–™åç§°,è§„æ ¼,ç³»ç»Ÿæ•°é‡,å®é™…æ•°é‡,å­˜æ”¾ä½ç½®,çŠ¶æ€\n";
      inventory.forEach((item, index) => {
        // å¤„ç†å«é€—å·æˆ–å¼•å·çš„å­—æ®µï¼ˆç”¨åŒå¼•å·åŒ…è£¹ï¼‰
        const fields = [
          index + 1,
          item.code || "",
          item.name || "",
          item.spec || "",
          item.sysQty || "0",
          item.realQty || "",
          item.location || "",
          item.duplicate? "é‡å¤" : "æ­£å¸¸"
        ].map(field => {
          const str = String(field);
          return str.includes(',') || str.includes('"')? `"${str.replace(/"/g, '""')}"` : str;
        });
        csvContent += fields.join(',') + "\n";
      });

      // åˆ›å»ºBlobå¹¶ä¸‹è½½
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      saveAs(blob, `åº“å­˜ç›˜ç‚¹æ•°æ®_${new Date().toLocaleDateString()}.csv`);
      showTip("CSVå¯¼å‡ºæˆåŠŸ");
    }

    // å¯¼å‡ºä¸ºExcel
    function exportToExcel() {
      if (inventory.length === 0) {
        showTip("æ²¡æœ‰æ•°æ®å¯å¯¼å‡º", "error");
        return;
      }

      // å‡†å¤‡Excelæ•°æ®
      const wsData = [
        ["åºå·", "ç‰©æ–™ç¼–å·", "ç‰©æ–™åç§°", "è§„æ ¼", "ç³»ç»Ÿæ•°é‡", "å®é™…æ•°é‡", "å­˜æ”¾ä½ç½®", "çŠ¶æ€"]
      ];
      
      inventory.forEach((item, index) => {
        wsData.push([
          index + 1,
          item.code || "",
          item.name || "",
          item.spec || "",
          item.sysQty || "0",
          item.realQty || "",
          item.location || "",
          item.duplicate? "é‡å¤" : "æ­£å¸¸"
        ]);
      });

      // åˆ›å»ºå·¥ä½œç°¿å¹¶å¯¼å‡º
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "åº“å­˜ç›˜ç‚¹æ•°æ®");
      XLSX.writeFile(wb, `åº“å­˜ç›˜ç‚¹æ•°æ®_${new Date().toLocaleDateString()}.xlsx`);
      showTip("Excelå¯¼å‡ºæˆåŠŸ");
    }

    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    function updateSummary() {
      totalCountEl.textContent = inventory.length;
      // ç»Ÿè®¡å·²å¡«å†™å®é™…æ•°é‡çš„ç‰©æ–™
      const counted = inventory.filter(item => item.realQty!== "" && item.realQty!== null).length;
      countedCountEl.textContent = counted;
    }

    // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
    function showTip(message, type = "success") {
      tipEl.textContent = message;
      tipEl.style.backgroundColor = type === "error"? "#ff4d4f" : "#52c41a";
      tipEl.style.display = "block";
      // 3ç§’åè‡ªåŠ¨éšè—
      setTimeout(() => {
        tipEl.style.display = "none";
      }, 3000);
    }

    // æ»šåŠ¨åˆ°é¡¶éƒ¨
    function scrollToTop() {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // æ»šåŠ¨åˆ°åº•éƒ¨
    function scrollToBottom() {
      window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    }

    // ç‚¹å‡»ç©ºç™½å¤„å…³é—­å¼¹çª—
    window.onclick = function(event) {
      if (event.target.classList.contains('modal')) {
        closeFormatModal();
      }
    }
  </script>
</body>
</html>