<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>库存盘点系统（修复优化版）</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:10px; background:#f9f9f9; }
    h2 { margin-top: 0; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { border:1px solid #ccc; padding:8px; text-align:center; }
    th { background:#f0f0f0; }
    tr.duplicate { background:#ffe0e0; }
    .controls { margin:10px 0; }
    button { margin:2px; padding:6px 10px; }
    input[type="file"] { margin:5px 0; }
  </style>
</head>
<body>
  <h2>📦 库存盘点系统（修复优化版）</h2>

  <div class="controls">
    <button onclick="addRow()">➕ 新增行</button>
    <button onclick="exportCSV()">⬇️ 导出 CSV</button>
    <button onclick="exportExcel()">⬇️ 导出 Excel</button>
    <input type="file" id="importFile" accept=".csv,.xlsx" onchange="handleImport(event)">
    <input type="text" id="searchBox" placeholder="🔍 搜索...">
  </div>

  <table id="inventoryTable">
    <thead>
      <tr>
        <th>序号</th>
        <th>物料编号</th>
        <th>物料描述</th>
        <th>系统数量</th>
        <th>实际数量</th>
        <th>备注</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    let data = JSON.parse(localStorage.getItem("inventoryData") || "[]");
    let debounceTimer = null;

    // 保存数据
    function saveData() {
      localStorage.setItem("inventoryData", JSON.stringify(data));
    }

    // 渲染表格
    function renderTable(filter="") {
      const tbody = document.querySelector("#inventoryTable tbody");
      tbody.innerHTML = "";

      // 重复检测：用 Map 统计料号次数
      const codeMap = new Map();
      data.forEach(item => {
        const code = (item.code || "").trim().toUpperCase();
        if (code) {
          codeMap.set(code, (codeMap.get(code) || 0) + 1);
        }
      });

      data.forEach((row, i) => {
        if (filter && !Object.values(row).some(v => (v || "").includes(filter))) return;
        const tr = document.createElement("tr");

        // 重复料号标红
        if (row.code && codeMap.get(row.code.trim().toUpperCase()) > 1) {
          tr.classList.add("duplicate");
        }

        tr.innerHTML = `
          <td>${i + 1}</td>
          <td contenteditable oninput="updateCell(${i}, 'code', this.innerText)">${row.code||""}</td>
          <td contenteditable oninput="updateCell(${i}, 'desc', this.innerText)">${row.desc||""}</td>
          <td contenteditable oninput="updateCell(${i}, 'sysQty', this.innerText)">${row.sysQty||""}</td>
          <td contenteditable oninput="updateCell(${i}, 'actQty', this.innerText)">${row.actQty||""}</td>
          <td contenteditable oninput="updateCell(${i}, 'remark', this.innerText)">${row.remark||""}</td>
          <td><button onclick="deleteRow(${i})">❌ 删除</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    // 更新单元格
    function updateCell(i, key, val) {
      data[i][key] = val;
      saveData();
      renderTable(document.querySelector("#searchBox").value.trim());
    }

    // 新增行
    function addRow() {
      data.push({ code:"", desc:"", sysQty:"", actQty:"", remark:"" });
      saveData();
      renderTable();
    }

    // 删除行
    function deleteRow(i) {
      data.splice(i, 1);
      saveData();
      renderTable();
    }

    // 导出 CSV
    function exportCSV() {
      const rows = [["序号","物料编号","物料描述","系统数量","实际数量","备注"]];
      data.forEach((row,i) => rows.push([i+1,row.code,row.desc,row.sysQty,row.actQty,row.remark]));
      const csv = rows.map(r=>r.map(x=>`"${x||""}"`).join(",")).join("\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "库存盘点.csv"; a.click();
    }

    // 导出 Excel
    function exportExcel() {
      const rows = [["序号","物料编号","物料描述","系统数量","实际数量","备注"]];
      data.forEach((row,i) => rows.push([i+1,row.code,row.desc,row.sysQty,row.actQty,row.remark]));
      let table = rows.map(r=>"<tr>"+r.map(x=>`<td>${x||""}</td>`).join("")+"</tr>").join("");
      const html = `<table>${table}</table>`;
      const blob = new Blob([html], {type:"application/vnd.ms-excel"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "库存盘点.xls"; a.click();
    }

    // 导入 CSV
    function handleImport(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(evt) {
        const text = evt.target.result;
        const rows = text.split(/\r?\n/).map(r => r.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g));
        data = rows.slice(1).filter(r=>r).map(r => ({
          code: r[1]?.replace(/"/g,"")||"",
          desc: r[2]?.replace(/"/g,"")||"",
          sysQty: r[3]?.replace(/"/g,"")||"",
          actQty: r[4]?.replace(/"/g,"")||"",
          remark: r[5]?.replace(/"/g,"")||""
        }));
        saveData();
        renderTable();
      };
      reader.readAsText(file,"utf-8");
    }

    // 搜索（防抖）
    document.querySelector("#searchBox").addEventListener("input", e=>{
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(()=>{
        renderTable(e.target.value.trim());
      }, 300);
    });

    // 初始化
    renderTable();
  </script>
</body>
</html>